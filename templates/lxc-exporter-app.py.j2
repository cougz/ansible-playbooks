#!/usr/bin/env python3
import subprocess
from flask import Flask, Response

app = Flask(__name__)

@app.route('/metrics')
def metrics():
    # Execute the metrics script to get fresh data
    try:
        subprocess.run(['/opt/otelcol-contrib/lxc-metrics-script.sh'], 
                      check=True, 
                      timeout=30)  # 30 second timeout to prevent hanging
        
        # Read the fresh metrics file
        with open('/var/lib/otelcol-contrib/lxc_metrics.prom', 'r') as f:
            metrics_content = f.read()
        
        return Response(metrics_content, mimetype='text/plain')
    
    except subprocess.CalledProcessError as e:
        return f"Error running metrics script: {e}", 500
    except subprocess.TimeoutExpired:
        return "Metrics script timed out", 500
    except FileNotFoundError:
        return "Metrics file not found", 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9100)
